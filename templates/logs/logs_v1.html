{% load tz %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs em Tempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-4">Logs Endpoints SubidoPro</h1>
    <div class="w-full h-[800px] max-w-3xl bg-gray-800 p-4 rounded-lg shadow-lg">
        <div id="logs" class="space-y-2 h-full overflow-auto">
            {% for log in logs %}
                <div class="p-2 bg-gray-700 rounded-md">
                    <strong>{{ log.acao }}</strong> na tabela 
                    <strong>{{ log.tabela }}</strong> - Status: 
                    <strong>{{ log.status }}</strong> - 
                    {{ log.criado_em|timezone:"America/Sao_Paulo" }}
                </div>
            {% endfor %}
        </div>
    </div>
    <script>
        (function() {
            const socket = new WebSocket(`ws://${window.location.host}/ws/logs/`);
            const logContainer = document.getElementById("logs");

            const handleSocketOpen = () => {
                console.log("WebSocket conectado!");
            };

            const handleSocketClose = (event) => {
                console.log("WebSocket desconectado:", event);
            };

            const handleSocketError = (error) => {
                console.error("Erro no WebSocket:", error);
            };

            const handleSocketMessage = (event) => {
                console.log("Mensagem recebida:", event.data);

                try {
                    const data = JSON.parse(event.data);

                    if (isValidLogData(data)) {
                        const logEntry = createLogEntry(data);
                        logContainer.prepend(logEntry);
                    } else {
                        console.warn("Mensagem recebida sem o formato esperado:", data);
                    }
                } catch (error) {
                    console.error("Erro ao processar mensagem WebSocket:", error);
                }
            };

            const isValidLogData = (data) => {
                return data && typeof data.acao === 'string' && typeof data.tabela === 'string' && typeof data.status === 'string' && typeof data.criado_em === 'string';
            };

            const createLogEntry = (data) => {
                const logEntry = document.createElement("div");
                logEntry.classList.add("p-2", "bg-gray-700", "rounded-md");
                logEntry.innerHTML = `<strong>${data.acao}</strong> na tabela <strong>${data.tabela}</strong> - Status: <strong>${data.status}</strong> - ${data.criado_em}`;
                return logEntry;
            };

            socket.onopen = handleSocketOpen;
            socket.onclose = handleSocketClose;
            socket.onerror = handleSocketError;
            socket.onmessage = handleSocketMessage;
        })();
    </script>
</body>
</html>