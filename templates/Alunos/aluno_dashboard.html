{% extends 'Alunos/aluno_campeonato.html' %}
{% load humanize %}

{% block containerAluno %}
<!-- =============================================================== -->
<!-- INÍCIO DO CONTEÚDO DO DASHBOARD DO ALUNO                        -->
<!-- =============================================================== -->
<div class="space-y-8">

        <!-- Grid de Estatísticas (KPIs) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mb-8">
        <!-- Card de Estatística: Faturamento Total -->
        <div class="bg-white p-5 rounded-xl shadow-md flex items-center gap-4">
            <div class="p-3 rounded-full bg-green-100 text-green-700">
                <span class="material-symbols-outlined">monetization_on</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Faturamento Total</p>
                <p class="text-2xl font-bold text-gray-800">R$ {{ soma_de_todos_valores|floatformat:2|intcomma }}</p>
            </div>
        </div>
        <!-- Card de Estatística: Mês de Ouro -->
        <div class="bg-white p-5 rounded-xl shadow-md flex items-center gap-4">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-700">
                <span class="material-symbols-outlined">calendar_month</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Mês de Ouro</p>
                <p class="text-xl font-bold text-gray-800">R$ {{ mes_mais_ganhou.total_mes|floatformat:2|intcomma }}</p>
            </div>
        </div>
    </div>
    
    <!-- Seção de KPIs Principais -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-5 rounded-xl shadow-md">
            <p class="text-sm text-gray-500">Total de Envios</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_envios|intcomma }}</p>
            <p class="text-xs text-gray-400 mt-1"><span class="text-green-500 font-semibold">{{ total_aprovados|intcomma }} Aprovados</span> / <span class="text-red-500 font-semibold">{{ total_reprovados|intcomma }} Reprovados</span></p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-md">
            <p class="text-sm text-gray-500">Total de Clientes</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_clientes|intcomma }}</p>
             <p class="text-xs text-gray-400 mt-1"><span class="text-blue-500 font-semibold">{{ novos_clientes|intcomma }} Novos</span> / <span class="text-red-500 font-semibold">{{ clientes_reprovados|intcomma }} Reprovados</span></p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-md">
            <p class="text-sm text-gray-500">Total de Contratos</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_contratos|intcomma }}</p>
            <p class="text-red-500 font-semibold">{{ contratos_reprovados|intcomma }} Reprovados</p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-md">
            <p class="text-sm text-gray-500">Clientes Retidos</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_clientes_retidos|intcomma }}</p>
            <p class="text-xs text-gray-400 mt-1">Clientes com recorrência</p>
        </div>
    </div>

    <!-- Seção de Gráficos de Evolução -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Gráfico de Envios por Mês -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700">Evolução de Envios</h3>
            <div class="h-64 mt-4">
                <canvas id="enviosChart"></canvas>
            </div>
        </div>
        <!-- Gráfico de Clientes Retidos por Mês -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700">Evolução de Clientes Retidos</h3>
            <div class="h-64 mt-4">
                <canvas id="retidosChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Seção de Análise de Contratos e Hábitos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Gráfico de Contratos por Tipo -->
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700">Contratos por Tipo</h3>
            <div class="h-64 mt-4 flex items-center justify-center">
                <canvas id="contratosChart"></canvas>
            </div>
        </div>
        <!-- Cards de Hábitos e Campeonatos -->
        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-md text-center">
                    <span class="material-symbols-outlined text-4xl text-purple-500">calendar_month</span>
                    <p class="text-sm text-gray-500 mt-2">Dia Preferido para Envios</p>
                    <p class="text-3xl font-bold text-gray-800">Dia {{ dia_mais_comum.dia_formatado }}</p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md text-center">
                    <span class="material-symbols-outlined text-4xl text-sky-500">schedule</span>
                    <p class="text-sm text-gray-500 mt-2">Horário de Pico</p>
                    <p class="text-3xl font-bold text-gray-800">{{ horario_mais_comum.hora_formatada }}</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Participação em Campeonatos</h3>
                <ul class="space-y-2">
                    {% for camp in campeonatos_participantes %}
                    <li class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-lg mr-2 text-gray-400">military_tech</span>
                        <span class="font-medium text-gray-700">{{ camp.identificacao }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>


{{ envios_por_mes|json_script:"envios-data" }}
{{ clientes_retidos_por_mes|json_script:"retidos-data" }}
{{ contratos_por_tipo|json_script:"contratos-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const primaryColor = '#1C46A0';

    // Gráfico 1: Envios por Mês
    const enviosData = JSON.parse(document.getElementById('envios-data').textContent);
    if (enviosData.length > 0) {
        const enviosCtx = document.getElementById('enviosChart').getContext('2d');
        new Chart(enviosCtx, {
            type: 'bar',
            data: {
                labels: enviosData.map(item => item.mes_ano),
                datasets: [{
                    label: 'Total de Envios',
                    data: enviosData.map(item => item.total),
                    backgroundColor: `${primaryColor}CC`,
                    borderColor: primaryColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    // Gráfico 2: Clientes Retidos por Mês
    const retidosData = JSON.parse(document.getElementById('retidos-data').textContent);
    if (retidosData.length > 0) {
        const retidosCtx = document.getElementById('retidosChart').getContext('2d');
        new Chart(retidosCtx, {
            type: 'line',
            data: {
                labels: retidosData.map(item => item.mes_ano),
                datasets: [{
                    label: 'Clientes Retidos',
                    data: retidosData.map(item => item.clientes_retidos),
                    backgroundColor: `${primaryColor}33`,
                    borderColor: primaryColor,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    // Gráfico 3: Contratos por Tipo
    const contratosData = JSON.parse(document.getElementById('contratos-data').textContent);
    if (contratosData.length > 0) {
        const tipoMap = { 1: 'Valor Fixo', 2: 'Coprodução', 3: 'Variável' };
        const contratosCtx = document.getElementById('contratosChart').getContext('2d');
        new Chart(contratosCtx, {
            type: 'doughnut',
            data: {
                labels: contratosData.map(item => tipoMap[item.tipo_contrato] || 'Outro'),
                datasets: [{
                    data: contratosData.map(item => item.total),
                    backgroundColor: ['#1C46A0', '#4F8CFF', '#AABFFF'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }
});
</script>
<!-- =============================================================== -->
<!-- FIM DO CONTEÚDO DO DASHBOARD DO ALUNO                           -->
<!-- =============================================================== -->
{% endblock %}
