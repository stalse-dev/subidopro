{% for cliente in clientes %}
    <div class="bg-sky-900 text-white p-4 flex items-center justify-between border-l-4 border-gray-400 shadow-md mt-3">
        <div class="flex items-center gap-4">
            <button onclick="toggleDivContratos(this)" class="bg-white text-gray-800 rounded w-6 h-6 flex items-center justify-center font-bold">
                <svg class="icon-contratos h-5 w-5 text-gray-600 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.584l3.71-4.354a.75.75 0 111.14.976l-4.25 5a.75.75 0 01-1.14 0l-4.25-5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
            </button>
            <div class="flex gap-6 text-xs text-gray-300">
                <p class="text-sm">
                <span class="text-gray-300">{{ cliente.id }}</span>
                <span class="font-bold ml-2">
                    {% if cliente.titulo|length > 40 %}
                        {{ cliente.titulo|slice:":40" }}...
                    {% else %}
                        {{ cliente.titulo|default:"Sem Cliente" }}
                    {% endif %}
                </span>
                </p>
                <p class="text-xs text-gray-300">pessoa jurídica<br>{{ cliente.documento }}</p>
            </div>
        </div>

        <div class="flex gap-6 text-xs text-gray-300">
            <p><span class="text-white font-semibold">{{ cliente.qtd_contratos }}</span> CONTRATOS</p>
            <p><span class="text-white font-semibold">{{ cliente.qtd_envios }}</span> RECEBIMENTOS</p>
        </div>

        
        <div class="flex items-center gap-4">
            <div class="text-xs text-gray-300 text-right">
                <span>{{ cliente.data_criacao|date:"l" }}</span><br>
                <span class="font-bold ml-2 text-white">
                    {{ cliente.data_criacao|date:"d/m/Y H:i" }}
                </span><br>
            </div>
            
            {% if cliente.status == 0 %}
                <button class="bg-white text-gray-800 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                    <svg class="w-3 h-3 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                    NÃO ANALISADO
                </button>
            {% elif cliente.status == 1 %}
                <button class="bg-white text-green-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                    <svg class="w-3 h-3 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    APROVADO
                </button>
            {% elif cliente.status == 2 %}
                <button class="bg-white text-red-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                    <svg class="w-3 h-3 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    INVALIDADO
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Aqui está a div de contratos fora da principal do cliente -->
    <div class="div-contratos hidden pl-10 border-l-4 border-gray-400">
        <div class="text-sm text-gray-700">
            <div class="flex justify-between font-semibold text-gray-500 mb-1 p-1 pr-6">
                <div>Contrato</div>
                <div>Assinatura</div>
                <div>Vencimento</div>
                <div>Remuneração</div>
                <div>Arquivo</div>
                <div>Status</div>
            </div>
            {% for contrato in cliente.contratos.all %}

                <div class="bg-sky-100 py-4 pl-4 rounded-tl-lg rounded-bl-lg mb-2">
                    <div id="div-contrato" class="flex justify-between items-center font-semibold text-gray-800 p-2 pr-4">
                        <div class="flex gap-6 text-xs text-gray-900 border-r-2 border-white pr-4">
                            <button onclick="toggleDivRecebimentos(this)" class="bg-white text-gray-800 rounded w-6 h-6 flex items-center justify-center">
                                <svg id="icon-recebimentos" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.584l3.71-4.354a.75.75 0 111.14.976l-4.25 5a.75.75 0 01-1.14 0l-4.25-5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <p class="text-sm">
                                <span class="text-gray-600">{{ contrato.id }}</span>
                                <span class="font-bold ml-2">
                                {% if contrato.tipo_contrato == 1 %}
                                    Valor Fixo Mensal
                                {% elif contrato.tipo_contrato == 2 %}
                                    Coprodução / Multisserviços
                                {% elif contrato.tipo_contrato == 3 %}
                                    Valor Variável
                                {% else %}
                                    Outros
                                {% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="text-xs text-right text-gray-600 border-r-2 border-white pr-4">
                            {{ contrato.data_contrato|date:"l" }}<br>
                            <span class="text-gray-800 font-bold">{{ contrato.data_contrato|date:"d/m/Y" }}</span>
                        </div>
                        <div class="text-xs text-right text-gray-600 border-r-2 border-white pr-4">
                            {{ contrato.data_vencimento|date:"l" }}<br>
                            <span class="text-gray-800 font-bold">{{ contrato.data_vencimento|date:"d/m/Y"|default:"Sem vencimento" }}</span>
                        </div>
                        <div class="text-gray-800 border-r-2 border-white pr-4">
                            R$ {{ contrato.valor_contrato|floatformat:2 }}
                        </div>

                        {% if contrato.arquivo1 %}
                            <a href="{{ contrato.arquivo1 }}" target="_blank" class="flex items-center gap-1 text-gray-700 hover:text-gray-900 font-medium cursor-pointer border-r-2 border-white pr-4 transition duration-200 font-bold">
                                <span class="material-symbols-outlined text-lg">description</span>
                                <span>Contrato</span>
                            </a>
                        {% else %}
                            <div class="flex items-center gap-1 text-gray-400 border-r-2 border-white pr-4">
                                <span class="material-symbols-outlined text-lg">description</span>
                                <span>Sem contrato</span>
                            </div>
                        {% endif %}
                        
                        {% if cliente.status == 0 %}
                            <button class="bg-white text-gray-800 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                <svg class="w-3 h-3 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                                </svg>
                                NÃO ANALISADO
                            </button>
                        {% elif cliente.status == 1 %}
                            <button class="bg-white text-green-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                <svg class="w-3 h-3 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                APROVADO
                            </button>
                        {% elif cliente.status == 2 %}
                            <button class="bg-white text-red-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                <svg class="w-3 h-3 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                INVALIDADO
                            </button>
                        {% endif %}
                    </div>
                
                    <!-- Subrecebmentos -->
                    <div class="div-recebimentos hidden pl-10">
                        <div class="flex justify-between font-semibold text-gray-500 mb-1 p-1 pr-6">
                            <div>Descrição</div>
                            <div>Recebimento</div>
                            <div>Cadastro</div>
                            <div>Valor</div>
                            <div>Arquivo </div>
                            <div>Status</div>
                        </div>
                        {% for recebimento in contrato.envios_contrato_cl.all %}
                            <div class="bg-white p-4 rounded-tl-lg rounded-bl-lg mb-2">
                                <div class="div-recebimento flex justify-between items-center font-semibold text-gray-800">
                                    <div class="flex gap-6 text-xs text-gray-900 border-r-2 border-gray-100 pr-4">
                                        <p class="text-sm">
                                        <span class="text-gray-600">{{ recebimento.id }}</span>
                                            <span class="font-bold ml-2">
                                                {% if recebimento.descricao|length > 25 %}
                                                    {{ recebimento.descricao|slice:":25" }}...
                                                {% else %}
                                                    {{ recebimento.descricao|default:"Sem descrição" }}
                                                {% endif %}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="text-xs text-right text-gray-600 border-r-2 border-gray-100 pr-4">
                                        {{ recebimento.data|date:"l" }}<br><span class="text-gray-800 font-bold">{{ recebimento.data|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="text-xs text-right text-gray-600 border-r-2 border-gray-100 pr-4">
                                        {{ recebimento.data_cadastro|date:"l" }}<br><span class="text-gray-800 font-bold">{{ recebimento.data_cadastro|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="text-gray-800 border-r-2 border-gray-100 pr-4">R$ {{ recebimento.valor_calculado|floatformat:2 }}</div>
                                    {% if recebimento.arquivo1 %}
                                        <a href="{{ recebimento.arquivo1 }}" target="_blank" class="flex items-center gap-1 text-gray-700 hover:text-gray-900 font-medium cursor-pointer border-r-2 border-white pr-4 transition duration-200 font-bold">
                                            <span class="material-symbols-outlined text-lg">description</span>
                                            <span>Recibo</span>
                                        </a>
                                    {% else %}
                                        <div class="flex items-center gap-1 text-gray-400 border-r-2 border-white pr-4">
                                            <span class="material-symbols-outlined text-lg">description</span>
                                            <span>Sem recibo</span>
                                        </div>
                                    {% endif %}
                                    {% if recebimento.status == 0 %}
                                        <button class="bg-white text-gray-800 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                            <svg class="w-3 h-3 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                                            </svg>
                                            NÃO ANALISADO
                                        </button>
                                    {% elif recebimento.status == 1 %}
                                        <button class="bg-white text-yellow-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                            <svg class="w-3 h-3 text-yellow-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 5a7 7 0 110 14a7 7 0 010-14z" />
                                            </svg>
                                            PENDENTE
                                        </button>
                                    {% elif recebimento.status == 3 %}
                                        <button class="bg-white text-green-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                            <svg class="w-3 h-3 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            APROVADO
                                        </button>
                                    {% elif recebimento.status == 2 %}
                                        <button class="bg-white text-red-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                            <svg class="w-3 h-3 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                            INVALIDADO
                                        </button>
                                    {% elif recebimento.status == 3 %}
                                        <button class="bg-white text-green-700 text-xs font-bold px-3 py-1 rounded shadow flex items-center gap-1">
                                            <svg class="w-3 h-3 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            APROVADO
                                        </button>
                                {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <div class="bg-white p-4 rounded-lg mb-2 shadow flex items-center gap-2 text-gray-500 text-sm">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                                </svg>
                                Nenhum recebimento encontrado.
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-4" role="alert">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                            </svg>
                            <span class="font-semibold">Nenhum contrato cadastrado para este cliente.</span>
                        </div>
                    </div>
                {% endfor %}
        </div>
    </div>
{% empty %}
    <div class="mt-4 p-6 bg-yellow-100 text-yellow-800 rounded shadow-md text-center">
        Nenhum cliente encontrado.
    </div>
{% endfor %}

<script>
    function toggleDivContratos(button) {
        const icon = button.querySelector('.icon-contratos'); // isso agora funcionará para cada botão individual
        const divCliente = button.closest('.bg-sky-900'); // container do cliente
        const content = divCliente.nextElementSibling; // .div-contratos logo após
    
        if (content && content.classList.contains('div-contratos')) {
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180'); // aplica rotação
        }
    }
    

    function toggleDivRecebimentos(button) {
        const icon = button.querySelector('#icon-recebimentos');
        const divContrato = button.closest('#div-contrato');
        const content = divContrato.parentElement.querySelector('.div-recebimentos');
        divContrato.classList.toggle("border-b-2");
        divContrato.classList.toggle("border-white");

    
        if (content) {
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }
    }

</script>