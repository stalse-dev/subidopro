{% load static %}
{% load django_htmx %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubidoPro</title>
    <link rel="shortcut icon" href="https://subidopro.com.br/img/favicon.png?6769b3322459a">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Usando mais pesos da fonte para maior flexibilidade no design -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="{% static 'htmx/htmx.min.js' %}" defer></script>
    
    <meta name="htmx-config" content='{"includeIndicatorStyles": false}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo base do corpo */
        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f9fa; /* Um fundo levemente cinza para destacar o conteúdo */
            /* Adicionado para evitar que o conteúdo comece sob a navbar fixa */
            padding-top: 5rem; 
        }
        
        /* Estilos da tela de carregamento (mantidos) */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .loading-screen.fade-out { opacity: 0; }
        .loading-screen span { font-size: 1.5rem; color: #1C46A0; font-weight: bold; }
        body.hidden { overflow: hidden; }

        /* Animações para os dropdowns (entrada e saída) */
        .scale-in-top {
            animation: scale-in-top 0.2s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }
        .scale-out-top {
            animation: scale-out-top 0.2s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
        }

        @keyframes scale-in-top {
            0% { transform: scale(0.95); transform-origin: top right; opacity: 0; }
            100% { transform: scale(1); transform-origin: top right; opacity: 1; }
        }
        @keyframes scale-out-top {
            0% { transform: scale(1); transform-origin: top right; opacity: 1; }
            100% { transform: scale(0.95); transform-origin: top right; opacity: 0; }
        }
    </style>
</head>
<body class="hidden">
    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="loading-screen">
        <span>Carregando...</span>
    </div>

    <!-- ===== NavBar Início ===== -->
    <nav class="bg-[#1C46A0] shadow-lg fixed top-0 left-0 w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="/">
                        <img class="h-8 w-auto" src="https://subidopro.com.br/img/logo-subido-pro-negativo.2f7b8cf2611a.svg" alt="Logo SubidoPRO" onerror="this.onerror=null;this.src='https://placehold.co/150x40/1C46A0/FFFFFF?text=SubidoPRO';">
                    </a>
                </div>

                <!-- Links do Menu Desktop -->
                <div class="hidden md:flex items-center space-x-8">
                    {% if user.is_authenticated %}
                        <a href="{% url 'campeonatos' %}" class="text-white hover:text-blue-300 transition-colors duration-300 font-medium text-base relative group">
                            Campeonatos
                            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-300 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                        </a>
                        <a href="" class="text-white hover:text-blue-300 transition-colors duration-300 font-medium text-base relative group">
                            Health SubidoMetro
                            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-300 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                        </a>
                        {% if user.is_superuser %}
                            <a href="" class="text-white hover:text-blue-300 transition-colors duration-300 font-medium text-base relative group">
                                Logs
                                <span class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-300 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                            </a>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Menu de Usuário (Desktop) e Botão Hamburger (Mobile) -->
                <div class="flex items-center">
                    {% if user.is_authenticated %}
                        <!-- Menu de Usuário (visível em desktop) -->
                        <div class="hidden md:block relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 text-white hover:text-blue-300 focus:outline-none transition-colors duration-300">
                                <span class="font-semibold">{{ user.name|capfirst }}</span>
                                <span id="user-menu-icon" class="material-symbols-outlined transition-transform duration-300">expand_more</span>
                            </button>
                            <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white text-gray-800 rounded-lg shadow-xl overflow-hidden z-50">
                                <a href="{% url 'alunos' %}" class="block px-4 py-3 text-sm hover:bg-gray-100 transition-colors duration-200">Todos alunos</a>
                                <a href="{% url 'clientes' %}" class="block px-4 py-3 text-sm hover:bg-gray-100 transition-colors duration-200">Todos clientes</a>
                                {% if user.is_superuser %}
                                    <a href="{% url 'balanceamento' %}" class="block px-4 py-3 text-sm hover:bg-gray-100 transition-colors duration-200">Balanceamento</a>
                                    <a href="{% url 'retencao' %}" class="block px-4 py-3 text-sm hover:bg-gray-100 transition-colors duration-200">Retenção</a>
                                {% endif %}
                                <div class="border-t border-gray-200"></div>
                                <a href="{% url 'logout' %}" class="block px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors duration-200">Sair</a>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Botão Hamburger (visível em mobile) -->
                    <div class="md:hidden flex items-center">
                        <button id="mobile-menu-btn" class="inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-blue-800 focus:outline-none transition-colors duration-300">
                            <span id="mobile-menu-icon" class="material-symbols-outlined">menu</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Menu Mobile (oculto por padrão) -->
        <div id="mobile-menu" class="hidden md:hidden bg-blue-900/50 backdrop-blur-sm">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                {% if user.is_authenticated %}
                    <a href="{% url 'ranking_semana' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Ranking Semanal Individual</a>
                    <a href="{% url 'ranking_cla' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Ranking Semanal Clã</a>
                    {% if user.is_superuser %}
                        <a href="{% url 'ranking' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Ranking Real Time</a>
                    {% endif %}
                    
                    <!-- Links do usuário no menu mobile -->
                    <div class="border-t border-blue-700 my-4"></div>
                    <div class="px-3 py-2 text-white font-semibold">{{ user.name|capfirst }}</div>
                    <a href="{% url 'alunos' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Alunos</a>
                    <a href="{% url 'clientes' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Clientes</a>
                    {% if user.is_superuser %}
                        <a href="{% url 'balanceamento' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Balanceamento</a>
                        <a href="{% url 'retencao' %}" class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-800 transition-colors duration-300">Retenção</a>
                    {% endif %}
                    <a href="{% url 'logout' %}" class="text-red-400 block px-3 py-2 rounded-md text-base font-medium hover:bg-red-500 hover:text-white transition-colors duration-300">Sair</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <!-- ===== NavBar Fim ===== -->

    <main class="p-4 md:p-8">
        {% block containerBodyMain %} 
        {% endblock %}
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // --- Lógica da Tela de Carregamento ---
            const loadingScreen = document.getElementById("loading-screen");
            if (loadingScreen) {
                document.body.classList.remove("hidden");
                loadingScreen.classList.add("fade-out");
                setTimeout(() => {
                    loadingScreen.style.display = "none";
                }, 500);
            }

            // --- Lógica do Menu de Usuário (Desktop) ---
            const userMenuBtn = document.getElementById("user-menu-btn");
            const userDropdown = document.getElementById("user-dropdown");
            const userMenuIcon = document.getElementById("user-menu-icon");

            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    const isHidden = userDropdown.classList.contains("hidden");
                    
                    if (isHidden) {
                        userDropdown.classList.remove('hidden', 'scale-out-top');
                        userDropdown.classList.add('scale-in-top');
                        userMenuIcon.style.transform = 'rotate(180deg)';
                    } else {
                        userDropdown.classList.remove('scale-in-top');
                        userDropdown.classList.add('scale-out-top');
                        userMenuIcon.style.transform = 'rotate(0deg)';
                        setTimeout(() => {
                            userDropdown.classList.add('hidden');
                        }, 200);
                    }
                });
            }

            // --- Lógica do Menu Hamburger (Mobile) ---
            const mobileMenuBtn = document.getElementById("mobile-menu-btn");
            const mobileMenu = document.getElementById("mobile-menu");
            const mobileMenuIcon = document.getElementById("mobile-menu-icon");

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener("click", function () {
                    const isHidden = mobileMenu.classList.contains("hidden");
                    mobileMenu.classList.toggle("hidden");
                    mobileMenuIcon.textContent = isHidden ? "close" : "menu";
                });
            }

            // --- Fechar dropdowns ao clicar fora ---
            document.addEventListener("click", function (event) {
                if (userDropdown && !userDropdown.classList.contains('hidden') && !userMenuBtn.contains(event.target) && !userDropdown.contains(event.target)) {
                    userDropdown.classList.remove('scale-in-top');
                    userDropdown.classList.add('scale-out-top');
                    userMenuIcon.style.transform = 'rotate(0deg)';
                    setTimeout(() => {
                        userDropdown.classList.add('hidden');
                    }, 200);
                }
            });
        });
    </script>
</body>
</html>
