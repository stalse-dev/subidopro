{% extends 'Campeonato/Campeonato.html' %}
{% load humanize %}

{% block containerCntMain %}
<!-- =============================================================== -->
<!-- INÍCIO DO CONTEÚDO DA PÁGINA DE RANKING SEMANAL                 -->
<!-- =============================================================== -->
<div>
    <!-- Cabeçalho e Filtros -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Ranking Semanal</h2>
                <p class="text-sm text-gray-500">
                    {% if ultima_att %}
                        Última atualização em: {{ ultima_att|date:"d/m/Y H:i" }}
                    {% else %}
                        Ranking da semana
                    {% endif %}
                </p>
            </div>
            <form method="get" action="" class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <!-- Filtro de Semana -->
                <div class="relative w-full sm:w-40">
                    <select name="semana" onchange="this.form.submit()" class="w-full appearance-none pl-3 pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#1C46A0]">
                        {% for s in semanas_disponiveis %}
                            <option value="{{ s }}" {% if s == semana %}selected{% endif %}>Semana {{ s }}</option>
                        {% endfor %}
                    </select>
                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">expand_more</span>
                </div>
                <!-- Barra de Busca -->
                <div class="relative w-full sm:w-72">
                    <input type="text" name="q" value="{{ q }}" placeholder="Buscar por aluno..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#1C46A0]">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela/Lista do Ranking -->
    <div class="space-y-3">
        {% for rank in alunos %}
            <details class="group bg-white rounded-lg shadow-sm overflow-hidden transition-shadow hover:shadow-md">
                <summary class="list-none cursor-pointer">
                    <div class="flex items-center p-4">
                        <!-- Posição e Medalha -->
                        <div class="flex-shrink-0 w-12 text-center">
                            {% if rank.posicao == 1 %}
                                <span class="material-symbols-outlined text-4xl text-yellow-400">emoji_events</span>
                            {% elif rank.posicao == 2 %}
                                <span class="material-symbols-outlined text-4xl text-gray-400">emoji_events</span>
                            {% elif rank.posicao == 3 %}
                                <span class="material-symbols-outlined text-4xl text-amber-600">emoji_events</span>
                            {% else %}
                                <span class="text-xl font-bold text-gray-600">{{ rank.posicao }}°</span>
                            {% endif %}
                        </div>
                        
                        <a href="{% url 'faturamento_aluno' rank.aluno.id %}" class="group/link flex-grow flex items-center mx-4 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <img class="h-10 w-10 rounded-full object-cover mr-4" src="https://placehold.co/40x40/EBF4FF/7F9CF5?text={{ rank.aluno.apelido|default:rank.aluno.nome_completo|default:'?'|first|upper }}" alt="Avatar">
                            <div>
                                <p class="font-bold text-gray-800 group-hover/link:text-[#1C46A0] transition-colors">{{ rank.aluno.apelido|default:rank.aluno.nome_completo }}</p>
                                <p class="text-xs text-gray-500">{{ rank.cla.nome|default:"Sem clã" }}</p>
                            </div>
                        </a>

                        <!-- Pontos Totais -->
                        <div class="flex-shrink-0 text-right mx-4">
                            <p class="text-lg font-bold text-[#1C46A0]">{{ rank.pontos_totais|floatformat:0 }}</p>
                            <p class="text-xs text-gray-500">Pontos Totais</p>
                        </div>

                        <!-- Ícone para expandir -->
                        <div class="flex-shrink-0 w-8 text-center text-gray-400 group-open:rotate-180 transition-transform">
                            <span class="material-symbols-outlined">expand_more</span>
                        </div>
                    </div>
                </summary>
                
                <!-- Detalhes dos Pontos (Conteúdo do Details) -->
                <div class="bg-gray-50/70 border-t border-gray-200 px-4 py-5">
                    <h4 class="text-sm font-semibold text-gray-700 mb-4 ml-2">Detalhamento de Pontos</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 text-center">
                        <!-- Item de Ponto -->
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Recebimento</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_recebimento|floatformat:0 }}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Desafio</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_desafio|floatformat:0 }}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Certificação</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_certificacao|floatformat:0 }}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Manual</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_manual|floatformat:0 }}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Contrato</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_contrato|floatformat:0 }}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <p class="text-sm text-gray-500">Retenção</p>
                            <p class="text-lg font-bold text-gray-800">{{ rank.pontos_retencao|floatformat:0 }}</p>
                        </div>
                    </div>
                </div>
            </details>
        {% empty %}
            <div class="text-center py-16 px-6 bg-white rounded-lg shadow-md">
                <span class="material-symbols-outlined text-6xl text-gray-300">leaderboard</span>
                <p class="font-semibold text-xl mt-4 text-gray-700">Nenhum ranking encontrado.</p>
                <p class="text-gray-500 text-sm mt-1">Não há dados para a semana selecionada ou para a sua busca.</p>
            </div>
        {% endfor %}
    </div>

    <!-- Paginação -->
    {% if alunos.has_other_pages %}
    <div class="flex items-center justify-between bg-white px-4 py-3 sm:px-6 rounded-lg shadow-md mt-6">
        <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    Mostrando de
                    <span class="font-medium">{{ alunos.start_index }}</span>
                    a
                    <span class="font-medium">{{ alunos.end_index }}</span>
                    de
                    <span class="font-medium">{{ cont_rank }}</span>
                    resultados
                </p>
            </div>
            <div>
                <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                    {% if alunos.has_previous %}
                    <a href="?page={{ alunos.previous_page_number }}&q={{ q }}&semana={{ semana }}" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <span class="material-symbols-outlined text-sm">chevron_left</span>
                    </a>
                    {% endif %}
                    {% for i in alunos.paginator.page_range %}
                        {% if alunos.number == i %}
                            <a href="#" aria-current="page" class="relative z-10 inline-flex items-center bg-[#1C46A0] text-white px-4 py-2 text-sm font-semibold">{{ i }}</a>
                        {% elif i > alunos.number|add:'-3' and i < alunos.number|add:'3' %}
                            <a href="?page={{ i }}&q={{ q }}&semana={{ semana }}" class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">{{ i }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if alunos.has_next %}
                    <a href="?page={{ alunos.next_page_number }}&q={{ q }}&semana={{ semana }}" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <span class="material-symbols-outlined text-sm">chevron_right</span>
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
