{% extends "Campeonato/Campeonato.html" %}
{% load humanize %}

{% block containerCntMain %}

<div id="dashboard-content">
    <!-- Grid de Estatísticas -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8">
        <!-- Faturamento Total -->
        <div class="xl:col-span-2 bg-white p-5 rounded-xl shadow-lg flex items-center gap-4">
            <div class="p-4 rounded-full bg-green-100 text-green-700">
                <span class="material-symbols-outlined text-3xl">monetization_on</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Faturamento Total</p>
                <p class="text-3xl font-bold text-gray-800">R$ {{ faturamento_total|floatformat:2|intcomma }}</p>
            </div>
        </div>
        <!-- Total de Alunos -->
        <div class="bg-white p-5 rounded-xl shadow-lg flex items-center gap-4">
            <div class="p-3 rounded-full bg-blue-100 text-[#1C46A0]">
                <span class="material-symbols-outlined">groups</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Alunos</p>
                <p class="text-2xl font-bold text-gray-800">{{ alunos.count }}</p>
            </div>
        </div>
        <!-- Clãs na Disputa -->
        <div class="bg-white p-5 rounded-xl shadow-lg flex items-center gap-4">
            <div class="p-3 rounded-full bg-purple-100 text-purple-700">
                <span class="material-symbols-outlined">shield</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Clãs</p>
                <p class="text-2xl font-bold text-gray-800">{{ clas.count }}</p>
            </div>
        </div>
        <!-- Desafios Lançados -->
        <div class="bg-white p-5 rounded-xl shadow-lg flex items-center gap-4">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-700">
                <span class="material-symbols-outlined">flag</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Desafios</p>
                <p class="text-2xl font-bold text-gray-800">{{ desafios.count }}</p>
            </div>
        </div>
        <!-- Próximo Ranking -->
        <div class="bg-white p-5 rounded-xl shadow-lg flex items-center gap-4">
            <div class="p-3 rounded-full bg-red-100 text-red-700">
                <span class="material-symbols-outlined">military_tech</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Próx. Ranking</p>
                <p class="text-2xl font-bold text-gray-800">{{ dias_ate_sabado }} dias</p>
            </div>
        </div>
    </div>

        <!-- Seção de Leaderboards -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Top 3 Alunos -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Top 3 Alunos (Semana {{ semana }})</h3>
            <ul class="space-y-3">
                {% for aluno_rank in top_3_alunos %}
                <a href="{% url 'dashboard_aluno' aluno_rank.aluno.id %}" class="flex items-center p-3 rounded-lg transition-all duration-300 ease-in-out border-l-4 border-transparent hover:shadow-md hover:scale-105 
                           {% if aluno_rank.posicao == 1 %}hover:border-yellow-400{% elif aluno_rank.posicao == 2 %}hover:border-gray-400{% elif aluno_rank.posicao == 3 %}hover:border-amber-600{% endif %}">
                    <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/EBF4FF/7F9CF5?text={{ aluno_rank.aluno.apelido|default:aluno_rank.aluno.nome_completo|default:'?'|first|upper }}" alt="Avatar">
                    <div class="ml-4 flex-grow">
                        <p class="text-sm font-medium text-gray-900">{{ aluno_rank.aluno.nome_completo }}</p>
                        <p class="text-sm text-gray-500">{{ aluno_rank.pontos_totais|floatformat:0|intcomma }} Pontos</p>
                    </div>
                    <div class="ml-auto">
                        {% if aluno_rank.posicao == 1 %}
                            <span class="material-symbols-outlined text-3xl text-yellow-400">emoji_events</span>
                        {% elif aluno_rank.posicao == 2 %}
                            <span class="material-symbols-outlined text-3xl text-gray-400">emoji_events</span>
                        {% elif aluno_rank.posicao == 3 %}
                            <span class="material-symbols-outlined text-3xl text-amber-600">emoji_events</span>
                        {% endif %}
                    </div>
                </a>
                {% empty %}
                <p class="text-sm text-gray-500 p-3">Ainda não há dados para o ranking de alunos.</p>
                {% endfor %}
            </ul>
        </div>
        <!-- Top 3 Clãs -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Top 3 Clãs (Semana {{ semana }})</h3>
            <ul class="space-y-3">
                {% for cla_rank in top_3_clas %}
                <li class="flex items-center p-3 rounded-lg transition-all duration-300 ease-in-out border-l-4 border-transparent hover:shadow-md hover:scale-105
                           {% if cla_rank.posicao == 1 %}hover:border-yellow-400{% elif cla_rank.posicao == 2 %}hover:border-gray-400{% elif cla_rank.posicao == 3 %}hover:border-amber-600{% endif %}">
                    <img class="h-10 w-10 object-contain mr-3" src="{{ cla_rank.cla.brasao }}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/EBF4FF/7F9CF5?text={{ cla_rank.cla.sigla|default:'C' }}';">
                    <div class="flex-grow">
                        <p class="text-sm font-medium text-gray-900">{{ cla_rank.cla.nome }}</p>
                        <p class="text-sm text-gray-500">{{ cla_rank.pontos_totais|floatformat:0|intcomma }} Pontos</p>
                    </div>
                    <div class="ml-auto">
                        {% if cla_rank.posicao == 1 %}
                            <span class="material-symbols-outlined text-3xl text-yellow-400">military_tech</span>
                        {% elif cla_rank.posicao == 2 %}
                            <span class="material-symbols-outlined text-3xl text-gray-400">military_tech</span>
                        {% elif cla_rank.posicao == 3 %}
                            <span class="material-symbols-outlined text-3xl text-amber-600">military_tech</span>
                        {% endif %}
                    </div>
                </li>
                {% empty %}
                <p class="text-sm text-gray-500 p-3">Ainda não há dados para o ranking de clãs.</p>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Seção do Gráfico -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Evolução de Pontos (Top 3)</h3>
        <div class="h-96">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

</div>

<!-- **CORREÇÃO APLICADA AQUI** -->
<!-- Passa os dados do Django para uma tag script de forma segura -->
{{ grafico_dados|json_script:"grafico-dados" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lê os dados da tag script que criamos acima
    const rawData = JSON.parse(document.getElementById('grafico-dados').textContent);
    
    if (!rawData || rawData.length === 0) return;

    // 1. Preparar os dados para o gráfico
    const labels = rawData.map(d => `Sem. ${d.semana}`);
    const studentPoints = {}; // { aluno_id: [pontos_sem1, pontos_sem2, ...], ... }
    const studentNames = {}; // { aluno_id: "Nome Aluno", ... }

    // Mapeia todos os alunos e semanas
    rawData.forEach((semanaData, weekIndex) => {
        semanaData.alunos.forEach(aluno => {
            if (!studentPoints[aluno.aluno_id]) {
                // Inicializa o array de pontos com null para todas as semanas
                studentPoints[aluno.aluno_id] = new Array(labels.length).fill(null);
                studentNames[aluno.aluno_id] = aluno.nome;
            }
            // Preenche o ponto para a semana correta
            studentPoints[aluno.aluno_id][weekIndex] = aluno.pontos;
        });
    });

    // Função para gerar cores aleatórias e bonitas
    const generateColor = (index) => {
        const colors = [
            '#4A90E2', '#50E3C2', '#F5A623', '#F8E71C', '#D0021B',
            '#BD10E0', '#9013FE', '#417505', '#7ED321', '#B8E986'
        ];
        return colors[index % colors.length];
    };

    // 2. Criar os datasets para o Chart.js
    const datasets = Object.keys(studentPoints).map((alunoId, index) => {
        const color = generateColor(index);
        return {
            label: studentNames[alunoId],
            data: studentPoints[alunoId],
            borderColor: color,
            backgroundColor: `${color}33`, // Cor com transparência
            fill: false,
            tension: 0.3, // Deixa a linha mais suave
            pointRadius: 4,
            pointHoverRadius: 7
        };
    });

    // 3. Renderizar o gráfico
    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString('pt-BR') + ' pontos';
                            }
                            return label;
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
});
</script>

{% endblock %}
